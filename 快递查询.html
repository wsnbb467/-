<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å¿«é€’æŸ¥è¯¢ä¸­å¿ƒ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            background:#f2f2f2;
            font-family: Arial, sans-serif;
            padding: 15px;
        }
        h2 { text-align:center; }

        .input-box {
            background:white;
            padding:15px;
            border-radius:12px;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
            margin-bottom:20px;
        }
        input {
            width: 100%;
            padding: 12px;
            border:1px solid #ddd;
            border-radius:8px;
            font-size:16px;
            margin-bottom:10px;
        }
        button {
            width:100%;
            padding:12px;
            background:#4CAF50;
            color:white;
            border:none;
            border-radius:8px;
            font-size:16px;
        }
        .card {
            background:white;
            padding:15px;
            margin-bottom:15px;
            border-radius:12px;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
        }
        .tag {
            font-size:14px;
            color:#888;
            margin-bottom:8px;
        }
        .bold { font-weight:bold; }

        .dialog {
            position: fixed;
            left:0;
            top:0;
            width:100%;
            height:100%;
            background: rgba(0,0,0,.5);
            display:none;
            justify-content:center;
            align-items:center;
        }
        .dialog-content {
            width:90%;
            max-height:80%;
            background:white;
            padding:20px;
            border-radius:12px;
            overflow-y:auto;
        }
        .log-item{
            border-left:3px solid #4CAF50;
            padding:8px;
            margin-bottom:10px;
            background:#f8f8f8;
        }
    </style>
</head>

<body>

<h2>ğŸ“¦ æˆ‘çš„å¿«é€’</h2>

<div class="input-box">
    <input type="text" id="numInput" placeholder="è¯·è¾“å…¥å¿«é€’å•å·">
    <button onclick="addTracking()">æ·»åŠ å¿«é€’</button>
</div>

<div id="cardList"></div>

<!-- ç‰©æµè¯¦æƒ…å¼¹çª— -->
<div class="dialog" id="dialog">
    <div class="dialog-content" id="dialogContent"></div>
</div>

<script>

/* è‡ªåŠ¨è¯†åˆ«å¿«é€’å…¬å¸ï¼ˆæ”¯æŒ CORSï¼‰ */
async function detectCompany(num){
    const res = await fetch(`https://www.kuaidi100.com/autonumber/auto?num=${num}`);
    return res.json();
}

/* å…è´¹æŸ¥è¯¢æ¥å£ï¼Œä¸éœ€è¦keyã€ä¸éœ€è¦signã€ä¸è·¨åŸŸ */
async function queryFree(type, num){
    const res = await fetch(
        `https://www.kuaidi100.com/query?type=${type}&postid=${num}`
    );
    return res.json();
}

/* LocalStorage */
function save(list){
    localStorage.setItem("trackListA", JSON.stringify(list));
}
function load(){
    return JSON.parse(localStorage.getItem("trackListA") || "[]");
}

/* æ·»åŠ å¿«é€’ */
async function addTracking(){
    const num = document.getElementById("numInput").value.trim();
    if(!num) return alert("è¯·è¾“å…¥å¿«é€’å•å·");

    // 1. è‡ªåŠ¨è¯†åˆ«å¿«é€’å…¬å¸
    const auto = await detectCompany(num);
    if(!auto.length) return alert("æ— æ³•è¯†åˆ«å¿«é€’å…¬å¸");

    const type = auto[0].comCode;

    // 2. æŸ¥è¯¢å¿«é€’
    const info = await queryFree(type, num);

    if(!info || !info.data){
        console.log(info);
        return alert("æŸ¥è¯¢å¤±è´¥ï¼Œå¯èƒ½å•å·ä¸å­˜åœ¨");
    }

    // 3. ä¿å­˜
    const list = load();
    list.unshift({
        type,
        num,
        data: info.data
    });

    save(list);
    render();
    document.getElementById("numInput").value = "";
}

/* æ¸²æŸ“å¡ç‰‡ï¼ˆæœ€å¤š3æ¡ï¼‰ */
function render(){
    const list = load();
    const box = document.getElementById("cardList");
    box.innerHTML = "";

    list.slice(0,3).forEach((it, index) => {
        const last = it.data[0] || {};
        box.innerHTML += `
            <div class="card" onclick="showDetail(${index})">
                <div class="tag">${it.type}ï½œ${it.num}</div>

                <div class="bold">å¯„ä»¶äººï¼š-- (--)</div>
                <div class="bold">æ”¶ä»¶äººï¼š-- (--)</div>

                <div style="margin-top:10px;color:#333;">
                    å½“å‰ï¼š${last.context || "æš‚æ— ç‰©æµä¿¡æ¯"}
                </div>
            </div>
        `;
    });
}

/* å±•ç¤ºè¯¦æƒ… */
function showDetail(index){
    const item = load()[index];
    const box = document.getElementById("dialogContent");

    box.innerHTML = `<h3>${item.type} - ${item.num}</h3>`;

    item.data.forEach(log=>{
        box.innerHTML += `
            <div class="log-item">
                <div>${log.time}</div>
                <div>${log.context}</div>
            </div>
        `;
    });

    document.getElementById("dialog").style.display = "flex";
}

document.getElementById("dialog").onclick = () => {
    document.getElementById("dialog").style.display = "none";
};

render();
</script>

</body>
</html>
