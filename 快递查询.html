<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å¿«é€’æŸ¥è¯¢ä¸­å¿ƒ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            background:#f2f2f2;
            font-family: Arial, sans-serif;
            padding: 15px;
        }
        h2 { text-align:center; }

        .input-box {
            background:white;
            padding:15px;
            border-radius:12px;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
            margin-bottom:20px;
        }
        input {
            width: 100%;
            padding: 12px;
            border:1px solid #ddd;
            border-radius:8px;
            font-size:16px;
            margin-bottom:10px;
        }
        button {
            width:100%;
            padding:12px;
            background:#4CAF50;
            color:white;
            border:none;
            border-radius:8px;
            font-size:16px;
        }
        .card {
            background:white;
            padding:15px;
            margin-bottom:15px;
            border-radius:12px;
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
        }
        .tag {
            font-size:14px;
            color:#888;
            margin-bottom:8px;
        }
        .bold { font-weight:bold; }

        .dialog {
            position: fixed;
            left:0;
            top:0;
            width:100%;
            height:100%;
            background: rgba(0,0,0,.5);
            display:none;
            justify-content:center;
            align-items:center;
        }
        .dialog-content {
            width:90%;
            max-height:80%;
            background:white;
            padding:20px;
            border-radius:12px;
            overflow-y:auto;
        }
        .log-item{
            border-left:3px solid #4CAF50;
            padding:8px;
            margin-bottom:10px;
            background:#f8f8f8;
        }
    </style>
</head>

<body>

<h2>ğŸ“¦ æˆ‘çš„å¿«é€’</h2>

<div class="input-box">
    <input type="text" id="companyInput" placeholder="å¿«é€’å…¬å¸ä»£ç ï¼ˆå¦‚ï¼šyt, zt, sfï¼‰">
    <input type="text" id="numInput" placeholder="è¯·è¾“å…¥å¿«é€’å•å·">
    <input type="text" id="phoneInput" placeholder="å¯„ä»¶äººæ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰">
    <button onclick="addTracking()">æ·»åŠ å¿«é€’</button>
</div>

<div id="cardList"></div>

<!-- ç‰©æµå¼¹çª— -->
<div class="dialog" id="dialog">
    <div class="dialog-content" id="dialogContent"></div>
</div>

<script>
/* -------------------------------------
   ä½ éœ€è¦å¡«å†™è‡ªå·±çš„å¿«é€’100 API å‚æ•°
--------------------------------------- */
const KUAIDI100_KEY = "XvxnMatH9371";
const KUAIDI100_CUSTOMER = "063458B4730A246820B0AB5BF9FAC182";

/* ----------------------------
   å¿«é€’100 ä¸»æŸ¥è¯¢ï¼ˆå¯¹é½ Java ç¤ºä¾‹ï¼‰
----------------------------- */
async function kuaiDi100Query({ com, num, phone }) {
    const paramObj = { com, num };
    if (phone) paramObj.phone = phone;
    const param = JSON.stringify(paramObj);

    const sign = md5(param + KUAIDI100_KEY + KUAIDI100_CUSTOMER).toUpperCase();

    const form = new FormData();
    form.append("customer", KUAIDI100_CUSTOMER);
    form.append("sign", sign);
    form.append("param", param);

    const res = await fetch("https://poll.kuaidi100.com/poll/query.do", {
        method: "POST",
        body: form
    });
    return res.json();
}

/* ----------------------------
        LocalStorage æ“ä½œ
----------------------------- */
function save(list){
    localStorage.setItem("trackList", JSON.stringify(list));
}
function load(){
    return JSON.parse(localStorage.getItem("trackList") || "[]");
}

/* ----------------------------
        æ·»åŠ å¿«é€’
----------------------------- */
async function addTracking(){
    const com = document.getElementById("companyInput").value.trim();
    const num = document.getElementById("numInput").value.trim();
    const phone = document.getElementById("phoneInput").value.trim();

    if (!com || !num) return alert("è¯·å¡«å†™ å…¬å¸ä»£ç  å’Œ å•å·");

    const info = await kuaiDi100Query({ com, num, phone });

    if(!info || !info.data){
        console.log(info);
        return alert("æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥å…¬å¸ä»£ç æ˜¯å¦æ­£ç¡®");
    }

    const list = load();
    list.unshift({
        com,
        num,
        phone,
        sender: info.sender || {},
        receiver: info.receiver || {},
        data: info.data
    });

    save(list);
    render();

    document.getElementById("companyInput").value = "";
    document.getElementById("numInput").value = "";
    document.getElementById("phoneInput").value = "";
}

/* ----------------------------
        æ¸²æŸ“å¡ç‰‡ (æœ€å¤š3ä¸ª)
----------------------------- */
function render(){
    const list = load();
    const box = document.getElementById("cardList");
    box.innerHTML = "";

    list.slice(0,3).forEach((it, i) => {
        const last = it.data[0] || {};
        box.innerHTML += `
            <div class="card" onclick="showDetail(${i})">
                <div class="tag">${it.com}ï½œ${it.num}</div>

                <div class="bold">
                    å¯„ä»¶äººï¼š${it.sender.name || "--"} (${it.sender.addr || "--"})
                </div>

                <div class="bold">
                    æ”¶ä»¶äººï¼š${it.receiver.name || "--"} (${it.receiver.addr || "--"})
                </div>

                <div style="margin-top:10px;color:#333;">
                    å½“å‰ï¼š${last.context || "æš‚æ— ç‰©æµä¿¡æ¯"}
                </div>
            </div>
        `;
    });
}

/* ----------------------------
        ç‚¹å‡»å¡ç‰‡å¼¹å‡ºè¯¦æƒ…
----------------------------- */
function showDetail(index){
    const item = load()[index];
    const box = document.getElementById("dialogContent");

    box.innerHTML = `<h3>${item.com} - ${item.num}</h3>`;

    item.data.forEach(log=>{
        box.innerHTML += `
            <div class="log-item">
                <div>${log.time}</div>
                <div>${log.context}</div>
            </div>
        `;
    });

    document.getElementById("dialog").style.display="flex";
}

document.getElementById("dialog").onclick = () => {
    document.getElementById("dialog").style.display="none";
};

/* ----------------------------
 MD5 å®ç°ï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰
----------------------------- */
!function(){function e(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function t(t,n,r,o,a,i){return e((c=e(e(n,t),e(o,i)))<<(a=a)||c>>>32-a,r);var c}function n(e,n,r,o,a,i,c){return t(n&r|~n&o,e,n,a,i,c)}function r(e,n,r,o,a,i,c){return t(n&o|r&~o,e,n,a,i,c)}function o(e,n,r,o,a,i,c){return t(n^r^o,e,n,a,i,c)}function a(e,n,r,o,a,i,c){return t(r^(n|~o),e,n,a,i,c)}function i(t,i,c,s,u,l){return t=e(e(t,e(e(n(i,c,s,u,l),o(i,c,s,u,l),a(i,c,s,u,l)))),s)}window.md5=function(n){var r,o,c,s=[],u=1732584193,l=-271733879,f=-1732584194,d=271733878;n=function(e){for(var t="",n="",r=0;r<e.length;r++)t+=(n=e.charCodeAt(r).toString(16)).length<2?"0"+n:n;return t}(unescape(encodeURIComponent(n)));for(var p=0;p<n.length;p+=2)s.push(parseInt(n.substr(p,2),16));s.push(128);for(;s.length%64!=56;)s.push(0);for(var p=0;p<8;p++)s.push(0);for(p=0;p<s.length;p+=64){var h=s.slice(p,p+64);r=u,o=l,c=f;for(var m=0;m<64;m++){var v=h[m];u=i(u,l,f,d,132,v)}u=e(u,r),l=e(l,o),f=e(f,c),d=e(d,s)}return[u,l,f,d].map((function(e){return(e>>>0).toString(16).padStart(8,"0")})).join("")};
}();

render();
</script>

</body>
</html>